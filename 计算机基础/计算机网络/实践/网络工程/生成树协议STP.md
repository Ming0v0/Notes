

以太网交换机使用**生成树协议STP**(`Spanning Tree Protocol`)，可以在**提高网络可靠性的同时又避免环路**带来的各种问题。

**生成树算法STA**(Spanning Tree Algorithm)是生成树协议STP(Spanning Tree Protocol)的核心。它的实现目标是: 在**包含有物理环路的网络中，构建出一个能够连通全网各节点的树型无环逻辑拓扑。**

生成树算法的三个步骤

- **"选择" 根交换机**
- **"选择" 根端口**
- **"选举"指定端口并阻塞备用端口**

# **选举根交换机**

根交换机的选举条件：**网桥ID（BID）最小值当选**

![](attachment/Pasted%20image%2020231019230833.png)

**网桥ID（BID）由以下两部分构成**

```txt
优先级 + 交换机的基本MAC地址
```

- 范围：`0~61440`
- 步长：`4096`
- 默认值：`32768`

**网桥ID（BID）的比较方法**
1. 优先级取值越小，则网桥ID（BID）就越小
2. 若优先级相同，则比较MAC地址，从MAC地址的左侧开始依次比较，数值越小的，则网桥ID（BID）就小



# **选举根端口**

在**每一个==非跟交换机上==选出一个根端口RP（Root Port）并且只能是一个**

![](attachment/Pasted%20image%2020231019231951.png)

```txt
图中的非跟网桥E的Fa0/0/1和Fa0/0/02如何选举根端口？
1. 在两个端口路径成本相同和对端的网桥ID相同的情况下
2. 对比对端的端口ID（PID），选取PID最小，即对比非根网桥D的Fa0/0/1和Fa0/0/2
```

根端口RP用于接收根交换机发来的BPDU，也用来转发普通流量

根端口的特点：抵达根网桥最近的接口

根端口位置：一定在非网桥上

**根端口RP的选举条件**

1. BPDU接收端口到根交换机的路径成本最小

| 链路带宽  | 成本值 |
| --------- | ------ |
| 4 Mb/s    | 250    |
| 10 Mb/s   | 100    |
| 16 Mb/s   | 62     |
| 100  Mb/s | 19     |
| 1 Gb/s    | 4      |
| 10 Gb/s   | 2      |

2. 对端的网桥ID（BID最小）

3. 对端的端口ID（PID）最小
```txt
优先级 + 端口号
```
- 范围：0~240
- 步长：16
- 默认值：128

# **选举指定端口并阻塞备用端**

**在==每一个网段上==选出一个指定端口DP (Designated Port)并且只能是一个**

![](attachment/Pasted%20image%2020231019232540.png)

```txt
图中的非根网桥D的Fa0/0/02到非根网桥E的Fa0/0/02这一个网段上，如何选取指定端口并阻塞备用端？
1. 判断非根网桥D的Fa0/0/02到根交换机A的路径成本，即A→C→D=8，判断非根网桥E的Fa0/0/02到根交换机A的路径成本，即A→B→D→E=27
2. 选取到根交换机的路径成本最小的端口，即非根网桥D的Fa0/0/02为指定端口，剩余端口（非根网桥E的Fa0/0/02）则成为备用端口
```

指定端口DP用于转发根交换机发来的BPDU也用来转发普通流量

**指定端口DP的选举条件**
1. 根交换机的所有端口都是指定端口DP
2. 根端口的对端端口一定是指定端口DP
3. BPDU转发端口到根交换机的路径成本最小
4. 本端的网桥ID（BID最小）

**剩余端口成为备用端口AP (Alternate Port)，将它们阻塞，** 形成一个无环网络

