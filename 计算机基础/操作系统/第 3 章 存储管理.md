# 存储管理概念
计算机存储器的管理，存储管理的对象是内存以及作为内存的扩展和延伸的外存储器。存储管理的目标是为程序设计人员提供方便、安全和充分大的存储空间，提供一个内外存结合的满足需要的存储空间。

1. **内存的分配与回收**：为运行的进程分配内存空间,并在不需要时回收它们占据的空间。
2. **地址变换**：当程序中采用的地址和将其装入内存后的地址不一致时,要完成程序中采用的地址到内存地址的转换,即逻辑地址转换为物理地址，程序才能正确运行。通常有静态重定位、动态重定位。
3. **存储保护**：代码和数据共享，以节省内存空间和保持数据一致性。内存中程序相互干扰，要设置地址空间访问权限（读、写、执行）。
4. **存储扩充**：虚拟存储技术、覆盖技术、交换技术

    虚拟存储器是指一种实际上并不存在存储器，是由内存和外存连接成的存储器。
    基本思想是：*把当前正在使用的部分放在内存，其他暂时不用的部分放在外存，运行时根据需要进行调度*。即在不改变实际内存容量情况下，借助大容量外存解决内存不足问题。

    虚拟内存的最大容量与CPU的地址总线的位数有关。

![](C:\Users\Jun\OneDrive\我的文档\笔记\计算机基础\操作系统\images\程序的装入和链接.png)

 在程序环境下，要使程序运行，必须先为之创建进程。而创建进程的第一件事，便是将程序和数据装入内存。如何将一个用户源程序变为一个可在内存中执行的程序，通常都要经过以下几个步骤：
 - **编译：** 由编译程序(Compiler)将用户源代码编译成若干个目标模块(Object Module)。
- **链接：** 由链接程序(Linker)将编译后形成的一组目标模块，以及它们所需要的库函数链接在一起，形成一个完整的装入模块(Load Module)。
- **装入**：由装入程序(Loader)将装入模块装入内存。



# 存储管理基本技术
存储管理的目的和功能：
- 对主存空间进行分配和管理
- 提高主存的利用率
- “扩充”主存容量
- 实现地址的变换

**分区法**：把内存划分成若干分区，每个分区里容纳一个作业。

**固定分区**：分区的个数、分区的大小固定不变；每个分区只能放一道作业。
- 优点：管理方式简单。
- 缺点：内存空间利用率低。

**动态分区法**：分区大小和个数依作业情况而定；作业进入内存时才建分区。
- 优点：按需分配内存。
- 缺点：产生大量碎片。

**重定位分区分配**：通过紧缩可解决碎片问题；作业在内存中可以移动。
- 优点：解决了碎片的问题，提高了主存利用率。
- 缺点：增加了开销，但须消耗大量的 CPU 时间。

**对换技术**：作业（或进程）在内存和磁盘之间交换，换出暂时不能运行的作业（或进程），换入具备运行条件的作业（或进程）。

# 虚拟存储器
虚拟存储器：是由操作系统提供的一个假想的特大存储器。

虚拟存储器的基本特征：
- 虚拟扩充：不是物理上，而是逻辑上扩充了内存容量。
- 部分装入：每个作业不是全部一次性地装入内存，而是只装入一部分。
- 离散分配：不必占用连续的空间，而是“见缝插针”。
- 多次对换：所需的全部程序和数据要分成多次调入内存。
- 虚拟存储器受到的限制：指令中表示地址的字长、外存的容量。

# 分页存储管理技术
## 分页的概念
逻辑空间等分为页，物理空间等分为块，与页面大小相同。
逻辑地址表示：（如，页面大小为 1K）。
内存分配原则：以块为单位，逻辑上相邻的页可以分配在不相邻的内存块中。
页表：实现从页号到物理块号的地址映射。
地址映射：由硬件完成。

## 请求分页的基本思想
**基本思想**
地址空间分页，内存分块，页与块大小相同；作业部分装入内存。作业所占的各块不连续。若缺页，进行缺页中断处理，换入内存。利用快表可加速地址转换。

**缺页中断的概念**
缺页中断：要访问的页不在主存，需要操作系统将其调入主存后再进行访问。在这个时候，被内存映射的文件实际上成了一个分页交换文件。

**缺页中断发生时的事件顺序如下**
- 硬件陷入内核，在内核堆栈中保存程序计数器。大多数机器将当前指令的各种状态信息保存在特殊的 CPU 寄存器中。
- 启动一个汇编代码例程保存通用寄存器和其他易失的信息，以免被操作系统破坏。这个例程将操作系统作为一个函数来调用。
- 当操作系统发现一个缺页中断时，尝试发现需要哪个虚拟页面。通常一个硬件寄存器包含了这一信息，如果没有的话，操作系统必须检索程序计数器，取出这条指令，用软件分析这条指令，看看它在缺页中断时正在做什么。
- 一旦知道了发生缺页中断的虚拟地址，操作系统检查这个地址是否有效，并检查存取与保护是否一致。如果不一致，向进程发出一个信号或杀掉该进程。如果地址有效且没有保护错误发生，系统则检查是否有空闲页框。如果没有空闲页框，执行页面置换算法寻找一个页面来淘汰。
- 如果选择的页框“脏”了，安排该页写回磁盘，并发生一次上下文切换，挂起产生缺页中断的进程，让其他进程运行直至磁盘传输结束。无论如何，该页框被标记为忙，以免因为其他原因而被其他进程占用。
- 一旦页框“干净”后（无论是立刻还是在写回磁盘后），操作系统查找所需页面在磁盘上的地址，通过磁盘操作将其装入。该页面被装入后，产生缺页中断的进程仍然被挂起，并且如果有其他可运行的用户进程，则选择另一个用户进程运行。
- 当磁盘中断发生时，表明该页已经被装入，页表已经更新可以反映它的位置，页框也被标记为正常状态。
- 恢复发生缺页中断指令以前的状态，程序计数器重新指向这条指令。
- 调度引发缺页中断的进程，操作系统返回调用它的汇编语言例程。
- 该例程恢复寄存器和其他状态信息。

## 分页存储地址转为物理地址：
首先要知道页式存储管理的逻辑地址分为两部分：页号和页内地址。
物理地址分为两部分：
关系为：逻辑地址=页号+页内地址
物理地址=块号+页内地址
