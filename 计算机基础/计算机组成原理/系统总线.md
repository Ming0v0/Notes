**为什么要采取总线连接？**

计算机系统五大部件之间的互连方法有两种，一种是各部件之间使用的单独的连线，称为分散连接；另一种是将各部件连到一组公共信息传输线上，称为总线连接。

随着计算机应用领域的不断扩大。I/O设备的种类和数量越来越多，人们希望随时增添或减撤设备，用分散连接方式简直一筹莫展，由此出现了总线连接

# 总线的定义

总线连接是**连接多个部件的信息传输线，是各部件共享的传输介质**
特性：在某一时刻，只允许有一个部件向总线发送信息，而多个部件可以同时从总线上接受相同的信息
总线实际上是由许多传输线或通路组成

# 总线的分类

按数据的传送方式可分为并行传输总线和串行传输总线。在并行传输总线中，又可按传输数据宽度分为8位、16位、32位、64位等传输总线。若按总线的使用范围划分，则又有计算机（包括外设）总线、测控总线、网络通信总线等。

下面按连接部件不同介绍三类总线

## 片内总线

片内总线是指**芯片内部的总线**，如在CPU芯片内部，寄存器与寄存器之间、寄存器与算逻单元ALU之间都有片内总线连接

## 系统总线

系统总线是指CPU、主存、I/O设备（通过I/O接口）各大部件之间的信息传输线

按系统总线传输信息的不同，又可分位三类：数据总线、地址总线和控制总线
1. **数据总线用来传输各功能部件之间的数据信息**，它是**双向传输**总线，其位数与机器字长、存储字长有关。数据总线的位数称为数据总线宽度（小于等于机器字长，如果数据总线宽度为 8 位，在 64 位计算机中取一个字时必须 8 次访存）。
2. **地址总线主要用来指出数据总线上的源数据和目的数据在主存单元的地址或I/O设备的地址**，**单向传输**。地址线的位数与存储单元的个数有关。例如，从存储器读出一个数据时，则 CPU 要将此数据所在的存储单元的地址送到地址总线上。又如，将某数据经 I/O 设备数据，则 CPU 除了需将数据送到数据总线上，还需将该输出设备的地址送到地址总线上。
3. **控制总线由数据总线、地址总线都是被挂在总线上的所有部件共享**的，如何使部件能在不同时刻占用总线使用权，需依靠控制总线来完成，因此**控制总线是用来发出控制信号的传输线**
    例如，存储器读 / 写命令、I/O 设备读 / 写命令都是由 CPU 发出的；当某部件准备就绪时，便向 CPU 发出中断请求；当某部件需获得总线使用权时，也向 CPU 发出总线请求。

## 通信总线

这类总线用于计算机系统之间或计算机系统与其他系统之间的通信
按传输方式可分为两种：串行通信和并行通信
-   串行通信是指数据在单条1位宽的传输线上，一位一位地按顺序分时传送。
-   并行通信是指数据在多条并行1位宽的传输线上，同时由源传送到目的地

# 总线特性及性能指标

## 总线特性

从物理角度角度来看，总线是由许多导线直接印制在电路板（在微型计算机中称为主板）上的，计算机系统的其他部件通过插头与与水平方向总线插槽连接。
![[attachment/Pasted image 20220509155337.png]]

**总线特性**
为了保证机械上的可靠连接，必须规定其机械特定；为了确保电器上正切连接，必须规定其电器特定；为确保正确地连接不同部件，还需规定其功能特性和时间特性：
- 机械特定：指总线在机械连接方式上的一些性能，如插头、插座的尺寸、形状、管脚数及排列顺序。
- 电气特性：每一根传输线上信号的传输方向和有效的电平范围。
- 功能特性：每根传输线的功能，如地址总线用来指出地址码，数据总线用来传递数据，控制总线发出控制信号。
- 时间特性：信号的时序关系。

## 总线的性能指标

总线性能指标如下
**总线宽度**：数据线的根数，用 bit（位）表示，如 8 位、16 位、32 位、64 位。
**总线带宽**：每秒传输的最大字节数（MBps，兆字节每秒）。
$$总线带宽=总线的工作频率×总线的位宽/8$$
**时钟同步 / 异步**：总线上的数据与时钟同步工作的总线称为同步总线，否则为异步总线。
**总线复用**：一条信号线上分时传送两种信号。如 8086 地址总线和数据总线共用一组物理线路。
**信号线数**：地址总线、数据总线、控制总线三种总线数的总和。
**总线控制方式**。包括突发工作、自动配置、仲裁方式、逻辑方式、计数方式等。
其他指标。如负载能力。

### 总线带宽计算：例题
假设总线的时钟频率为100MHz，总线的传输周期为4个总线周期，总线的宽度为32位，试求总线的数据传输率
方法一
解：根据总线的时钟频率为100HMz，得：
1个时钟周期为：1/100MHz=0,01μs（时钟周期等于时钟频率的倒数）
1个总线传输周期为：0.01μs×4=0.04μs
总线宽度为32位：32bits/8=4B（字节）
总线的传输率=总线的带宽=4B*（1/0.04μs）=100MB/s

方法二: 注意观察一个传输周期等于几个时钟周期
总线的传输速率=总线的带宽=（32/8）B*（100MHz/4）=100MB/s

# 总线结构
## 单总线总线
![[attachment/Pasted image 20220509155712.png]]
单总线结构的特点是：它是将CPU、主存、I/O设备（通过I/O接口）都挂在一组总线上，允许I/O设备之间、I/O设备与CPU之间或I/O设备与主存之间直接交换信息。
缺点：不允许两个以上的部件在同一时刻向总线传输信息

## 多总线结构
### 双总线结构
![[attachment/Pasted image 20220509155758.png]]
双总线结构的特点是：将速度较低的I/O设备从单总线上分离出来，形成主存总线与I/O设备分开的结构。
图中的通道是一个具有特殊功能的处理器，CPU将一部分功能下放给通道，使其对I/O设备具有统一管理功能。
### 三总线结构
![[attachment/Pasted image 20220509155845.png]] 

# 总线控制
由于总线上连接着多个部件，什么时候由那个部件发送信息，如何给信息传送定时，如何防止信息丢失，如何避免多个部件同时发送，如何规定接收信息的部件等一系列问题都需要由总线控制器统一管理。它主要包括判优控制（或称仲裁逻辑）和通信控制
## 总线判优控制
总线上所连接的各类设备，按其对总线有无控制功能可分为主设备（模块）和从设备（模块）两种，**主设备对总线有控制权，从设备只能响应从主设备发来的总线命名，对总线没有控制权。** 总线上的信息由主设备启动的。
总线判优控制可分为集中式和分布式两种，前者将控制逻辑集中在一处（如在CPU中），后者将控制逻辑分散在总线连接的各个部件或设备上
    常见的集中控制权仲裁方式有以下三种。
（1）链式查询
    ![[attachment/Pasted image 20220509160005.png]]
*链式查询中，离总线控制部件最近的设备具有最高优先级*
- 工作流程：I/O设备通过接口向总线控制部件发送总线请求BR信号，总线控制部件接收到后，发出总线请求信号BG，从最近的一个I/O接口送到一个I/O接口，如果BG到达的接口有总线请求，BG信号就不再往下传，
    意味着该接口获得了总线的使用权，并建立总线忙BS信号，表示它占用了总线。
- 特点：只需要很少几根线就能按一定优先次序实现控制，并且很容易扩充设备，但对电路故障很敏感，且优先级别的低的设备可能很难获得请求。

（2）计数器定时查询
![[attachment/Pasted image 20220509160251.png]]
*与链式查询相比，多了一组设备地址线，少了一根总线同意线BG*
工作流程：总线控制部件接收到由BR送来的总线请求信号后，在总线未被使用（BS=0）的情况下，总线控制部件的计数器开始计数，并通过设备地址线，向各设备发出一组地址信号。当某个请求占用总线的设备与计数值一致时，便获得了总线使用权，此时终止计数查询。
特点：
- 计数可以从“0”开始，此时一旦设备的优先次序被固定，设备的优先级就按0,1,…，n的顺序降序排列，而且固定不变。
- 计数也可以从上一次计数的终止点开始，即是一种循环方法，此时设备使用总线的优先级相等
- 计数器的初始值还可由程序设置，故优先次序可以改变。
缺点：这种方式对电路故障不如链式查询方式敏感，但增加了控制线（设备地址）数，控制也较复杂

（3）独立请求方式
![[attachment/Pasted image 20220509160435.png]]
*每一台设备均有一对总线请求线BRi 和总线总线同意线BGi*
工作流程：当设备要求使用总线时，便发出该设备的请求信号。总线部件中有一排队电路，可以根据优先次序确定响应哪一台设备的请求
特点：响应速度快，优先次序控制灵活（通过程序改变），但控制线数量多，总线控制更加复杂

链式查询中仅用两根线确定总线使用权属于那个设备，在计数器查询中大致用根线，其中n是允许接纳的最大设备数，而独立请求方式需采用2n根线。

# 总线通信控制
通常将完成一次总线操作的时间称为总线周期，可分为以下四个阶段
1.  申请分配阶段：由需要使用总线的主模块（或主设备）提出请求，经总线仲裁机构决定下一传送周期的总线使用权授予某一申请者。
2.  寻址阶段：取得了使用权的主模块通过总线发出本次要访问的从模块（或从设备）的地址及有关命令，启动参与本次传输的从模块
3.  传数阶段：主模块和从模块进行数据交换，数据由源模块发出，经数据总线流入目的模块
4.  结束阶段：主模块的有关信息均从系统总线上撤除，让出总线使用权
总线通信控制主要解决通信双方如何获知传输开始和传输结束，以及通信双方如何协调如何配合。

## 同步通信
**通信双方有统一时标控制数据传送称为同步通信。** 时标通常由CPU的总线控制部件发出，送到总线上的所有设备；也可以由每个部件各自的时序发生器发出，但**必须由总线控制部件发出的时钟信号对他们进行同步**
![[attachment/Pasted image 20220509162530.png]]
图中的总线传输周期是连接在总线上的两个部件完成一次完整且可靠的信息传输时间
它包含4个时钟周期T1、T2、T3、T4
	T1 主模块发地址
	T2 主模块发读命令
	T3 从模块提供数据
	T4 主模块撤除读命令，从模块撤销数据

![[attachment/Pasted image 20220509162633.png]]
对于写命令，其传输周期如下：
	T1 主模块发地址
	T1.5 主模块发提供数据
	T2 主模块发出写，从模块收到命令后，必须在规定时间内将数据总线上的数据写到地址总线所指明的单元中
	T4 主模块撤除写命令和数据等信号
这种通信的优点是规定明确、统一，模块间的配合简单一致。
其缺点是主、从模块时间配合属于强制性“同步“，必须在限定时间内完成规定的要求。并且对所有从模块都用同一限时，这就势必造成，<u>对各不同速度的部件而言，必须按最慢速度的部件来设计公共时钟，严重影响总线的工作效率，也给设计带来了局限性，缺乏灵活性。</u>
同步通信一般用于总线长度较短，各部件存取时间比较一致的场合

# 异步通信
异步通信克服了同步通信的缺点，允许各模块速度的不一致性。它没有公共的时钟标准，不要求所有部件严格的统一操作时间，而是采用应答方式（又称握手方式），即**当主模块发出请求信号（Request）时，一直等待从模块反馈回来”响应“（Ac-konwledge）信号后才开始通信。** 当然，这就要求主、从模块之间增加两条应答线（握手交互信号线 Handshaking）。
![[attachment/Pasted image 20220509162741.png]]