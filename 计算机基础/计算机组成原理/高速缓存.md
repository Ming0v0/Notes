高速缓存用来存放当前最活跃的程序和数据，其特点是：位于 CPU 与主存之间；容量一般在几千字节到几兆字节之间；速度一般比主存快5、10 倍，由快速半导体存储器构成；其==内容是主存局部域的副本==，对程序员来说是透明的。

# 高速缓存的组成

高速缓存（ Cache ）、主存（ Mam Memory ）与 CPU 的关系

![](attachment/Pasted%20image%2020231004231717.png)


Cache 存储器部分用来存放主存的部分拷贝（副本）信息。
控制部分的功能是判断 CPU 要访问的信息是否在 Cache 存储器中，若在即为命中，若不在则没有命中。命中时直接对 Cache存储器寻址：未命中时，要按照替换原则决定主存的一块信息放到存储器的哪一块里。

![](attachment/Pasted%20image%2020231004231815.png)

# 高速缓存中的地址映像方法

在 CPU 工作时，送出的是主存单元的地址，而应从存储器中读/写信息。这就需要将主存地址转换成 Cache 存储器的地址，这种地址的转换称为地址映像。 Cache 的地址映像有如下 3 种方法。

## 直接映像

**直接映像是指主存的块与 Cache 块的对应关系是固定的**
![](attachment/Pasted%20image%2020231004232132.png)

在这种映像方式下，由于主存中的块只能存放在缓存存储器的相同块号中，因此，只要主存地址中的主存区号与缓存中记录的主存区号相同，则表明访问缓存命中。一旦命中，由主存地址中的区内块号立即可得到要访问的缓存存储器中的块，而块内地址就是主存地址中给出的低位地址。

**直接映像方式的优点是地址变换很简单，缺点是灵活性差。例如，不同区号中块号相同的块无法同时调入缓存存储器，即使缓存存储器中有空着的块也不能利用。**

## 全相联映像

同样，主存与 Cache 存储器均分成大小相同的块。这种映像方式**允许主存的任一块可以调入 Cache 存储器的任何一个块的空间中。**
![](attachment/Pasted%20image%2020231004235934.png)
例如，主存为 64MB，Cache 为 32KB，块的大小为 4KB(块内地址需要 12 位），因此主存分为 16384 块，块号从 0~16383，表示块号需要 14位，Cache 分为 8 块，块号为 0~7，表示块号需 3 位。存放主存块号的相联存储器需要有 Cache 块个数相同数目的单元(该例中为 8）,相联存储器中每个单元记录所存储的主存块的块号，该例中相联存储器每个单元应为 14 位，共8个单元。

在地址变换时，**利用主存地址高位表示的主存块号与 Cache 中相联存储器所有单元中记录的主存块号进行比较**，若相同即为命中。这时相联存储器单元的编号就对应要访问 Cache 的块号，从而在相应的 Cache 块中根据块内地址(上例中块内地址是 12 位，Cache 与主存的块内地址是相同的） 访问到相应的存储单元。

**全相联映像的主要优点是主存的块调入 Cache 的位置不受限制，十分灵活。其主要缺点是无法从主存块号中直接获得 Cache 的块号，变换比较复杂，速度比较慢。**

## 组相联映像
这种方式是前面两种方式的折中。具体方法是将 Cache 中的块再分成组。例如，假定 Cache 有 16 块，再将每两块分为 1组，则 Cache 就分为 8 组。主存同样分区，每区 16 块，再将每两块分为 1组，则每区就分为 8 组。

**组相联映像就是规定组采用直接映像方式而块采用全相联映像方式。** 也就是说，==主存任何区的0组只能存到 Cache 的0组中，1 组只能存到 Cache 的1组中，依此类推。组内的块则采用全相联映像方式，即一组内的块可以任意存放。也就是说，主存一组中的任一块可以存入Cache 相应组的任一块中。==

在这种方式下,通过直接映像方式来决定组号,在一组内再用全相联映像方式来决定 Cache中的块号。由主存地址高位决定的主在区号与 Cache 中区号比较可决定是否命中。主存后面的地址即为组号。


# 替换算法

**替换算法的目标就是使 Cache 获得尽可能高的命中率。**

常用算法有如下几种

1. 随机替换算法。就是用随机数发生器产生一个要替换的块号，将该块替换出去。
2. 先进先出算法。就是将最先进入 Cache 的信息块替换出去。
3. 近期最少使用算法。这种方法是将近期最少使用的 Cache 中的信息块替换出去。
4. 优化替换算法。这种方法必须先执行一次程序，统计 Cache 的替换情况。有了这样的先验信息，在第二次执行该程序时便可以用最有效的方式来替换。

# Cache的性能分析

Cache 的性能是计算机系统性能的重要方面。命中率是 Cache 的一个重要指标，但不是最主要的指标。**Cache 设计的目标是在成本允许的条件下达到较高的命中率，使存储系统具有最短的平均访问时间。** 设$H_c$ 为 Cache 的命中率，$t_c$,为 Cache 的存取时间，$t_m$ 为主存的访问时间，则 Cache 存储器的等效加权平均访问时间$t_a$为：
$$
t_a=H_ct_c+(1-H_c)t_m=t_c+(1-H_c)(t_m-t_c)
$$
这里假设 Cache 访问和主存访问是同时启动的，其中，$t_c$为 Cache 命中时的访问时间，$(t_m-t_c)$为失效访问时间。如果在 Cache 不命中时才启动主存，则
$$
t_a=t_c+(1-H_c)t_m
$$
在指令流水线中，Cache 访问作为流水线中的一个操作阶段，Cache 失效将影响指令的流水。因此，降低 Cache 的失效率是提高 Cache 性能的一项重要措施。当 Cache 容量比较小时，容量因素在 Cache 失效中占有比较大的比例。降低 Cache 失效率的方法主要有选择恰当的块容量、提高 Cache 的容量和提高 Cache 的相联度等。

Cache 的命中率与 Cache 容量的关系如图所示。
**Cache 容量越大，则命中率越高，随着 Cache 容量的增加，其失效率接近 0%(命中率逐渐接近 100%） 。但是，增加 Cache 容量意味着增加 Cache 的成本和增加 Cache 的命中时间。**
![](attachment/Pasted%20image%2020231005001655.png)
# 多级Cache

在多级 Cache 的计算机中,Cache 分为一级（L1 Cache）、二级（L2 Cache）、三级（L3 Cache）等，CPU 访存时首先查找 LI Cache，如果不命中，则访问 L2 Cache，直到所有级别的 Cache都不命中，才访问主存。通常要求 L1 Cache 的速度足够快，以赶上 CPU 的主频。如果 Cache为两级，则LI Cache 的容量一般都比较小，为几千字节到几十千字节; L2 Cache 则具有较高的容量，一般为几百字节到几兆字节，以使高速缓存具有足够高的命中率。