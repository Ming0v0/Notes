# 路由基础
![](attachment/Pasted%20image%2020231123125721.png)

路由：在网络通信中，路由（Route）是一个网络层的术语，作为名词它是指从某一网络设备出发去往某个目的地的路径，作为动词它是指跨越一个从源主机到目标主机的网络来转发数据包（不同网段之间转发）。

路由器：路由器（Router）是执行路由动作的一种网络设备，它能够将数据包转发到正确的目的地，并在转发过程中能选择最佳的路径，路由器工作在网络层。

路由表：路由表（Routing Table）是若干条路由信息的一个集合体。在路由表中，一条路由信息也被称为一个路由项或一个路由条目，路由设备根据路由表的路由条目做路径选择。

| 术语                    | 备注                 | 类比         |
| ----------------------- | -------------------- | ------------ |
| 路由（Routing）         | 不同网段的转发过程   | 火车         |
| 路由表（Routing Table） | 路由信息的集合       | 时刻表       |
| 路由器（Router）        | 常见的路由设备       | 火车站       |
| 网关地址（Gateway）     | 路由设备的接口IP地址 | 火车站的地址 | 



## 路由器的工作原理

![](attachment/Pasted%20image%2020231123125821.png)

路由器R1是该网络中正在运行的一台路由器，通过对网络设备进行配置之后，可以查看路由器R1的路由表

在路由器R1上执行`display ip routing-table` 命令便可查看到路由器R1的路由表，在这个路由表中，每一行就是一条路由信息（一个路由项或一个路由条目）。

通常情况下，一条路由信息由3个要素组成：`目标网络/掩码（Destination/Mask）`、`出接口（Interface）`和`下一跳IP地址（NextHop）`

![](attachment/Pasted%20image%2020231123130040.png)

> 补充说明：
> 
> 如果目的地/掩码中的掩码长度为32，则目的地将是一个主机接口地址，否则目的地就是一个网络地址。通常，我们总是说一个路由项的目的地是一个网络地址（即目标网络地址），而把主机接口地址视为目的地的一种特殊情况。
> 
> 如果一个路由项的下一跳IP地址与出接口的IP地址相同，则说明目标网络和本地接口是一个直连网络（双方在同一个网络）。
> 
> 下一跳IP地址所对应的那个主机接口与出接口一定是位于同一个二层网络（二层广播域）。


**路由信息的3个要素**

- 3.3.3.0是一个网络地址，掩码长度是24。由于路由器R1的路由表中存在3.3.3.0/24这个路由项，就说明路由器R1知道自己所在的网络上存在一个网络地址为3.3.3.0的网络

- 3.3.3.0这个路由项的出接口是GigabitEthernet1/0/2，其含义是，如果路由器R1需要将一个IP报文送往3.3.3.0/24这个目标网络，那么路由器R1应该把这个IP报文从路由器R1的GigabitEthernet1/0/2接口发送出去

- 3.3.3.0这个路由项下一跳IP地址（NextHop）是1.1.1.2，其含义是，如果路由器R1需要将一个IP报文送往3.3.3.0/24这个目标网络，则路由器R1应该把这个IP报文从路由器R1的GigabitEthernet1/0/2接口发送出去，并且这个IP报文离开路由器R1的GigabitEthernet1/0/2接口后应该到达的下一个路由器的接口的IP地址是1.1.1.2

除了这3个要素外，一个路由项通常还包含其他一些属性，例如，产生这个路由项的Protocol（路由表中Proto列），该路由项的Preference（路由表中Pre列），该条路由的代价值（路由表中Cost列）等。

- Protocol（路由表中Proto列）：该路由的协议类型，也即**路由器是通过什么协议或者该路由的**。直连（Direct）、静态（Static）、动态（Dynamic）

- Pre（路由表中Pre列）：表示此路由的路由协议优先级针对同一目的地，可能存在不同下一跳、出接口等多条路由这些不同的路由可能是由不同的路由协议发现的，也可以是手工配置的静态路由。**优先级最高（数值最小）者将成为当前的最优路由**

- 该条路由的代价值（路由表中Cost列）：路由开销。当到达同一目的地的多条路由具有相同的路由优先级时，**路由开销最小的将成为当前的最优路由。**

路由优先级的比较过程是
![](attachment/Pasted%20image%2020250313155641.png)

1. 首先比较路由的掩码，掩码长的优先
2. 然后比较路由的 `preference`，数字小的优先
3. 然后比较路由的 `cost`，数字小的优先
4. 如果都相同，则形成等价路由

那么，路由器是如何基于IP路由表进行转发工作的呢？以图所示的路由器R1的IP路由表为例，如果一个IP报文的目的IP地址为3.3.3.0，那么这个IP报文就匹配上了3.3.3.0/24这个路由项，且路由表里仅有一个3.3.3.0的表项，因此，路由器根据此表项进行IP报文的转发。

![](attachment/Pasted%20image%2020231123130040.png)

当一个IP报文同时匹配上了多个路由项时，路由器将根据“最长掩码匹配”原则来确定出一条最优路由，并根据最优路由来进行IP报文的转发，如果没有匹配项（包括默认路由），路由器将丢弃该数据包。

假如路由器R1的路由表中还有一条路由项是3.0.0.0/8，则路由器会根据“最长掩码匹配”原则，匹配上上了3.3.3.0/24这个路由项，而不是3.0.0.0/8，因为3.3.3.0/24所需的开销最小

### 最长匹配原则

将数据包的目的IP地址与自己本地路由表中的所有路由表项进行逐位（bit-by-bit）比对，直到找到匹配度最长的条目。

![](attachment/Pasted%20image%2020250313161818.png)

![](attachment/Pasted%20image%2020250313161837.png)

## 路由协议的分类

![](attachment/Pasted%20image%2020250314092955.png)

路由设备之间要相互通信，需通过路由协议来相互学习，以构建一个到达其他设备的路由信息表，然后才能根据路由表，实现IP数据包的转发。路由协议的常见分类如下。

![](attachment/Pasted%20image%2020250314093135.png)

根据**不同路由算法分类**，可分为以下两种：距离矢量路由协议和链路状态路由协议

- 距离矢量（DV Distance-Vector）路由协议：通过判断数据包从源主机到目的主机**所经过的路由器的个数**来决定选择哪条路由，如RIP等。（基于距离矢量算法）
- 链路状态（LS Link-State）路由协议：不是根据路由器的数目选择路径，而是综合考虑**从源主机到目的主机间的各种情况**（如带宽、延迟、可靠性、承载能力和最大传输单元等），最终选择一条最优路径，如OSPF、IS-IS等。（基于SPF（Shortest Path First，最短路径优先）算法）
![](attachment/Pasted%20image%2020250314093524.png)

![](attachment/Pasted%20image%2020250314093540.png)

![](attachment/Pasted%20image%2020250314093655.png)

![](attachment/Pasted%20image%2020250314093703.png)

根据**不同的工作范围**，可分为以下两种：内部网关协议（IGP）和外部网关协议（EGP）
- 自治系统（Autonomous System）：处于单个管理机制下的网络
- 内部网关协议（Interior Gateway Protocol）：在**一个自治系统内进行路由信息交换**的路由协议，如RIP、OSPF、ISIS等
 - 外部网关协议（Exterior Gateway Protocol）：在**不同自治系统间进行路由信息交换**的路由协议，如BGP。

![](attachment/Pasted%20image%2020250314093326.png)

根据**手动配置或自动学习两种不同的方式建立路由表**，可分为以下两种：静态路由协议和动态路由协议。

- 静态路由协议：由网络管理人员手动配置路由器的路由信息
- 动态路由协议：路由器自动学习路由信息，动态建立路由表



路由协议运行规则：
- 路由协议是在接口上运行的；
- 只能学习和发布相同路由协议已知的路由信息；
 - 如果不同的路由协议间需要交换路由信息，就需要进行引入/注入（import）。

![](attachment/Pasted%20image%2020250314093840.png)

## 路由表的生成与路由条目

**路由表的3种来源**

直连路由：设备自动发现、手动配置或通过动态路由协议生成。我们把设备自动发现的路由信息称为直连路由（Direct Route）

- 当路由器的某个**接口配置了IP地址并生效**，路由器会自动产生一个相关的直连路由条目，例如接口配置的地址`2.2.2.1 24`，路由器会判断出这个网段的网络地址，路由条目中自动出现一个和这个接口对应的`2.2.2.0 24`

静态路由：把**手动配置**的路由信息称为静态路由（Static Route）


动态路由：把网络设备通过运行动态路由协议而得到路由信息称为动态路由（Dynamic Route）

## 路由优先级

设备上的路由优先级一般都有默认值，不同厂家设备对于优先级的默认值可能不同。华为AR路由器上部分路由类型与优先级的默认值的对应关系，如下表所示。

| 路由类型 | 优先级的默认值 |
| -------- | -------------- |
| 直连路由 | 0              |
| OSPF     | 10             |
| 静态路由 | 60             |
| RIP      |  100              |
| BGP      | 255               |

## 路由的开销

什么是路由的开销：**路由的开销是指数据包从当前设备到达目标网络（目的地/掩码）所需付出的代价。**

路由开销的选择：同一种路由协议发现有多条路由可以到达同一目的地/掩码时，将**优选开销最小的路由**，即只把开销最小的路由加入进本协议的路由表中。

路由开销举例：不同的路由协议对于开销的具体定义是不同的。

例如：
- **RIP（Routing Information Protocol）** 以“跳数（Hop Count）”作为开销，每经过一个路由器，跳数加1。
- **OSPF（Open Shortest Path First）** 以“链路开销（Link Cost）”作为开销，默认根据接口带宽计算。
- **EIGRP（Enhanced Interior Gateway Routing Protocol）** 计算综合开销，考虑带宽、时延、负载等多个因素。
![](attachment/Pasted%20image%2020231123133230.png)

### 等价路由

同一种路由协议发现多条到达同一目的地/掩码的路由时，如果这些路由的开销相等，则称它们为等价路由。在支持负载分担的情况下，路由器可以在多条等价路由之间分摊流量，提高网络利用率。

![](attachment/Pasted%20image%2020250313161538.png)

常见的负载分担方式之一是基于五元组（源地址、目的地址、源端口、目的端口、协议）进行哈希计算，以决定数据包的转发路径。
- **当五元组相同时**，路由器通常会选择与上一次相同的下一跳地址发送报文，以保持流量一致性（即会话保持）。
- **当五元组不同时**，路由器会通过哈希算法重新计算路径，可能选择不同的下一跳进行转发，从而实现负载分担。

![](attachment/Pasted%20image%2020250313161731.png)

不同的路由协议对开销的定义方式不同，因此**开销值的大小只能在同一种路由协议内比较**。在不同的路由协议之间，开销值**没有可比性**，也**无法直接换算**。例如，RIP 以跳数计算开销，而 OSPF 以带宽计算开销，这两者的数值之间没有直接转换关系。

## 路由收敛：

- 网络拓扑变化引起的通过**重新计算路由而发现替代路由的行为**；
- 最终网络（路由）进入一个稳定状态，即收敛完成；
- 网络在收敛完成前无法完全正常工作。

衡量动态路由协议的一些性能指标：

| 指标  | 备注                         |
| --- | -------------------------- |
| 正确性 | 能够正确找到最优的路由，且无自环。          |
| 快收敛 | 当拓朴结构发生变化之后，能够迅速作出相应的路由改变。 |
| 低开销 | 协议自身的开销（内存、CPU、网络带宽）最小。    |
| 安全性 | 协议自身不易受攻击，有安全机制。           |
| 普适性 | 适应各种拓扑结构和各种规模的网络。          |

# 静态路由

## 静态路由概述

静态路由（Static Route）是指通过手动方式为路由器配置路由信息，可以简单地让路由器获知达到目标网络的路由。

## 静态路由的优缺点

- 优点：静态路由配置简单、路由器资源负载小、可控性强等优点
- 缺点：不能动态反映网络拓扑，当网络拓扑发生变化时，网络管理员就必须手动配置改变路由表，因此静态路由不适合于在大型网络中使用

## 静态路由的配置

静态路由配置：

| 命令                                             | 备注     |
| ---------------------------------------------- | ------ |
| ip route-static 目标网络 {子网掩码 / 前缀} {下一跳地址 / 出接口} | 配置静态路由 |

注意事项：
- 对于点到点接口（串口），只需指定出接口。
- 对于广播接口（以太网接口）和VT（Virtual-template）接口，必须指定下一跳。

**案例背景与要求**：在路由器R1和路由器R2上配置静态路由，实现网络互联互通。

![](attachment/Pasted%20image%2020231123133439.png)

**案例配置思路**

- 在路由器R1上配置一条静态路由，目的地/掩码为`3.3.3.0/24`，出接口为`GE1/0/2`，下一跳IP地址为`1.1.1.2`
- 在路由器R2上配置一条静态路由，目的地/掩码为`2.2.2.0/24`，出接口为`GE1/0/2`，下一跳IP地址为`1.1.1.1`

**案例配置过程**

配置路由器R1

```txt
system-view #进入系统视图
sysname R1 #将设备修改名字为R1

# ip route-static 目的地址 掩码长度 下一跳地址
ip route-static 3.3.3.0 24 1.1.1.2
```

配置路由器R2

```txt
system-view #进入系统视图
sysname R2 #将设备修改名字为R2

# ip route-static 目的地址 掩码长度 下一跳地址
ip route-static 2.2.2.0 24 1.1.1.1
```

```txt
ip route-static 目的地址 掩码长度 下一跳地址
```

- 目的地址：一般来说我们要找到一台电脑，是要找到这一台电脑IP所处在网段，例如我们要找到`3.3.3.2`这个IP的电脑


**案例验证**

在路由器R1系统视图状态下输入`display ip routing-table`命令查看其路由表

![](attachment/Pasted%20image%2020231123134054.png)

# 默认路由

## 默认路由概述

我们把目的地/掩码为`0.0.0.0/0`的路由称为默认（缺省）路由（Default Route）。

- 如果网络设备的路由表中**存在默认路由**，那么当一个待发送或待转发的IP报文**不能匹配IP路由表**中的任何非默认路由时，就会**根据默认路由来进行发送或转发**
- 如果网络设备的IP路由表中**不存在默认路由**，那么当一个待发送或待转发的IP报文**不能匹配**IP路由表中的**任何路由**时，该IP报文就会被**直接丢弃**

默认路由：一种特殊的路由，能匹配所有目标网络。

| 命令 | 备注 |
| ---- | ---- |
| ip route-static 0.0.0.0 {0.0.0.0 /0} {下一跳地址 / 出接口}     | 配置静态缺省路由     |


## 案例默认路由的配置

**案例背景与要求**：网络管拓扑所示，路由器R3是因特网服务提供商（Internet Service Provider, ISP）路由器，并且假设路由器R3上已经有了通往Internet的路由。要求管理员配置路由器，实现所有的PC都能够互通，并且都能够访问Internet。

![](attachment/Pasted%20image%2020231123134933.png)


**案例配置思路**

- 在路由器R1上配置一条静态路由，目的地/掩码为`3.3.3.0/24`，下一跳地址为路由器R2的GE1/0/2接口的IP地址`1.1.1.2`，出接口为路由器R1的GE1/0/2接口。另外，在路由器R1上配置一条默认路由，该默认路由的下一跳地址为路由器R3的GE1/0/0接口的IP地址`4.4.4.2`，出接口为路由器R1的GE1/0/0接口

- 在路由器R2上配置一条默认路由，该默认路由的下一跳地址为路由器R1的GE1/0/2口的E地址`1.1.1.1`，出接口为路由器R2的GE1/0/2接口

- 在路由器R3上配置一条默认路由，下一跳IP地址均为路由器R1的GE1/0/0接口的IP地址`4.4.4.1`，出接口均为路由器R3的GE1/0/0接口

**案例配置步骤**

配置路由器R1
```txt
system-view
sysname R1
ip route-static 3.3.3.0 24 1.1.1.2 # 配置静态路由
ip route-static 0.0.0.0  0 4.4.4.2 # 配置默认路由
```

配置路由器R2
```txt
system-view
sysname R2
ip route-static 0.0.0.0 0 1.1.1.1 # 配置默认路由
```

配置路由器R3
```txt
system-view
sysname R3
ip route-static 0.0.0.0 0 4.4.4.1 # 配置默认路由
```


**案例验证**

完成以上配置后，在路由器R1系统视图状态下输入`display ip routing-table`命令查看其路由表。从输出结果显示，路由器R1的路由表中己经有了一条默认路由。

![](attachment/Pasted%20image%2020231123135833.png)



### 路由递归

通过下一跳计算出直连出接口的过程，也称为路由迭代。
![](attachment/Pasted%20image%2020250313164323.png)

```txt
[RTA]ip route-static 30.1.2.0 24 20.1.1.3
```

去往30.1.2.0/24的路由，下一跳为20.1.1.3,非本地直连网络，如果路由表中没有去往20.1.1.3的路由，该静态路由将不会生效，无法作为有效路由条目，并不会出现在路由表。


![](attachment/Pasted%20image%2020250313164338.png)
```txt
[RTA]ip route-static 30.1.2.0 24 20.1.1.3
[RTA]ip route-static 20.1.1.3 24 10.0.0.2 
```

| 目的网络          | 下一条      | 出接口     |
| ------------- | -------- | ------- |
| 30.1.2.0/24   | 20.1.1.3 | GE0/0/0 |
| 20.0.1.1.0/24 | 10.0.0.2 | GE0/0/0 |

添加一条去往20.1.1.3的路由，下一跳为直连网络内的IP地址10.0.0.2。去往30.1.2.0/24的路由通过递归查询得到一个直连的下一跳，该路由因此生效。

### 浮动静态路由
通过调整优先级，实现路由的备份（即：主备备份）。

负载均衡：
![](attachment/Pasted%20image%2020250313164504.png)

主备备份：
![](attachment/Pasted%20image%2020250313164527.png)

配置案例：
![](attachment/Pasted%20image%2020250313164543.png)

RTA上配置浮动路由
```txt
[RTA]ip route-static 20.0.0.0 24 10.1.1.2
[RTA]ip route-static 20.0.0.0 24 10.1.2.2 preference 70
```


切换过程：
![](attachment/Pasted%20image%2020250313164622.png)


# Loopback接口

回环口，一种虚拟的接口

| 命令                    | 备注                               | 作用                                                                                                           |
| --------------------- | -------------------------------- | ------------------------------------------------------------------------------------------------------------ |
| interface loopback 编号 | 创建或配置一个回环口，保持Up状态<br><br>建议使用/32 | 模拟直连网段，可用于测试<br><br>设备管理（比物理口更稳定）<br><br>供其它协议使用（OSPF、BGP、MPLS等）<br><br>SNMP Traps 消息的源地址<br><br>其它用途等（十分广泛） |

![](attachment/Pasted%20image%2020250313170212.png)

```txt
[R1]int Loopback 0
[R1]ip address 1.1.1.1 32
```

# 路由汇总

CIDR：Classless Inter-Domain Routing，无类域间路由

对于如何优化分配公网地址，定义了两大主要目标：
1. 允许路由汇总，从而减小路由表规模
2. 允许子网划分，从而减少公网地址的浪费
即：打破传统A、B、C类地址划分，允许使用任意长度的掩码

![](attachment/Pasted%20image%2020250313170615.png)


路由汇总：把多个连续的前缀，聚合成一个前缀
- 减少路由表条目，降低资源（内存、CPU、带宽）占用。
- 还可以用来避免路由环路、路由震荡。
- 汇聚之前的这组路由称为明细路由或精细路由。
- 汇聚之后的这条路由称为汇总路由或聚合路由。

![](attachment/Pasted%20image%2020250313170755.png)

汇总计算：
![](attachment/Pasted%20image%2020250313170833.png)
**精确汇总**：汇总路由时，尽量精确，刚好包括所有明细路由。下图问题路由汇总范围太广
![](attachment/Pasted%20image%2020250313170943.png)
**环路问题**：
![](attachment/Pasted%20image%2020250313171654.png)

**解决方案：Null 0路由**
![](attachment/Pasted%20image%2020250313171819.png)

IP子网的规划：
不合理：
![](attachment/Pasted%20image%2020250313171933.png)合理：
![](attachment/Pasted%20image%2020250313172003.png)